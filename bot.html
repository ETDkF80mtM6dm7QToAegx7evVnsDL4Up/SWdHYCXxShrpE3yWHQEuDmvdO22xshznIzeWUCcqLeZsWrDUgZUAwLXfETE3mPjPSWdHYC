<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Amuthu AI Chat</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <style>
        :root {
            --primary: #1976d2;
            --primary-light: #e3f2fd;
            --primary-dark: #0d47a1;
            --secondary: #03a9f4;
            --background: #ffffff;
            --surface: #f5f5f5;
            --error: #f44336;
            --text-primary: #212121;
            --text-secondary: #757575;
            --shadow-1: 0 1px 3px rgba(0,0,0,0.12), 0 1px 2px rgba(0,0,0,0.24);
            --shadow-2: 0 3px 6px rgba(0,0,0,0.16), 0 3px 6px rgba(0,0,0,0.23);
            --shadow-3: 0 10px 20px rgba(0,0,0,0.19), 0 6px 6px rgba(0,0,0,0.23);
            --border-radius: 16px;
            --message-radius: 18px;
            --chat-bg: #f0f2f5;
            --user-bubble: #1976d2;
            --bot-bubble: #ffffff;
            --transition-speed: 0.3s;
        }

        [data-theme="dark"] {
            --primary: #90caf9;
            --primary-light: #1565c0;
            --primary-dark: #0d47a1;
            --background: #121212;
            --surface: #1e1e1e;
            --error: #cf6679;
            --text-primary: #ffffff;
            --text-secondary: #b3b3b3;
            --chat-bg: #1e1e1e;
            --user-bubble: #1976d2;
            --bot-bubble: #2d2d2d;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--background);
            color: var(--text-primary);
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            transition: background-color var(--transition-speed), color var(--transition-speed);
        }

        .app-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px 20px;
            background-color: var(--surface);
            box-shadow: var(--shadow-1);
            z-index: 100;
            transition: background-color var(--transition-speed);
        }

        .menu-button {
            background: none;
            border: none;
            color: var(--text-primary);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 40px;
            height: 40px;
            border-radius: 50%;
        }

        .chat-title {
            font-size: 18px;
            font-weight: 600;
            color: var(--text-primary);
            text-align: center;
            flex-grow: 1;
            max-width: 60%;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .user-profile {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            overflow: hidden;
            cursor: pointer;
            border: 2px solid var(--primary);
        }

        .user-profile img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .user-profile .material-icons {
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            color: var(--text-secondary);
            background-color: var(--surface);
        }

        .welcome-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 40px 20px;
            text-align: center;
            flex-grow: 1;
        }

        .welcome-text {
            font-size: 24px;
            font-weight: 300;
            margin-bottom: 16px;
            color: var(--text-primary);
            max-width: 80%;
        }

        .chat-container {
            display: none;
            flex-direction: column;
            height: 100%;
            flex-grow: 1;
        }

        .chat-messages {
            flex-grow: 1;
            padding: 20px;
            overflow-y: auto;
            background-color: var(--chat-bg);
            transition: background-color var(--transition-speed);
        }

        .message {
            display: flex;
            margin-bottom: 16px;
            max-width: 80%;
        }

        .message.user {
            align-self: flex-end;
            flex-direction: row-reverse;
        }

        .message-bubble {
            padding: 12px 16px;
            border-radius: var(--message-radius);
            box-shadow: var(--shadow-2);
            position: relative;
            word-wrap: break-word;
            max-width: 100%;
        }

        .message.user .message-bubble {
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            color: white;
            border-bottom-right-radius: 4px;
        }

        .message.bot .message-bubble {
            background-color: var(--bot-bubble);
            color: var(--text-primary);
            border-bottom-left-radius: 4px;
            border: 1px solid rgba(0,0,0,0.1);
        }

        .message-avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            margin: 0 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            background-color: var(--primary);
            flex-shrink: 0;
        }

        .message.user .message-avatar {
            background-color: var(--primary-dark);
            overflow: hidden;
        }

        .message.user .message-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .message-time {
            font-size: 11px;
            color: var(--text-secondary);
            margin-top: 4px;
            text-align: right;
        }

        .message.bot .message-time {
            text-align: left;
        }

        .input-container {
            padding: 16px;
            background-color: var(--surface);
            box-shadow: var(--shadow-2);
            display: flex;
            flex-direction: column;
            align-items: center;
            transition: background-color var(--transition-speed);
            position: relative;
        }

        .quick-actions {
            display: flex;
            justify-content: center;
            gap: 16px;
            margin-bottom: 16px;
            width: 100%;
        }

        .quick-action-button {
            width: 56px;
            height: 56px;
            border-radius: 50%;
            background-color: var(--primary);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: var(--shadow-2);
        }

        .quick-action-button .material-icons {
            font-size: 28px;
        }

        .input-pill {
            display: flex;
            align-items: center;
            background-color: var(--background);
            border-radius: 30px;
            box-shadow: var(--shadow-2);
            width: 90%;
            max-width: 600px;
            padding: 8px 8px 8px 20px;
            transition: box-shadow var(--transition-speed);
        }

        .input-pill:focus-within {
            box-shadow: var(--shadow-3);
        }

        .input-field {
            flex-grow: 1;
            background: none;
            border: none;
            font-family: 'Inter', sans-serif;
            font-size: 16px;
            color: var(--text-primary);
            outline: none;
            padding: 8px 12px;
        }

        .send-button {
            background-color: var(--primary);
            color: white;
            border: none;
            border-radius: 50%;
            width: 44px;
            height: 44px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
        }

        .send-button .material-icons {
            font-size: 20px;
        }

        .input-hint {
            position: absolute;
            bottom: 70px;
            left: 50%;
            transform: translateX(-50%);
            background-color: var(--surface);
            color: var(--text-secondary);
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 14px;
            box-shadow: var(--shadow-2);
            opacity: 0;
            transition: opacity var(--transition-speed);
            pointer-events: none;
            z-index: 10;
        }

        .input-hint.visible {
            opacity: 1;
        }

        .side-menu {
            position: fixed;
            top: 0;
            left: -300px;
            width: 300px;
            height: 100%;
            background-color: var(--surface);
            box-shadow: var(--shadow-3);
            z-index: 200;
            transition: left var(--transition-speed);
            display: flex;
            flex-direction: column;
            overflow-y: auto;
        }

        .side-menu.open {
            left: 0;
        }

        .menu-header {
            padding: 20px;
            display: flex;
            align-items: center;
            border-bottom: 1px solid rgba(0,0,0,0.1);
        }

        .menu-close {
            background: none;
            border: none;
            color: var(--text-primary);
            cursor: pointer;
            margin-right: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 36px;
            height: 36px;
            border-radius: 50%;
        }

        .menu-title {
            font-size: 20px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .menu-section {
            padding: 16px 0;
        }

        .menu-item {
            display: flex;
            align-items: center;
            padding: 12px 20px;
            cursor: pointer;
            color: var(--text-primary);
        }

        .menu-item .material-icons {
            margin-right: 16px;
            color: var(--primary);
        }

        .menu-divider {
            height: 1px;
            background-color: rgba(0,0,0,0.1);
            margin: 8px 0;
        }

        .overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            z-index: 150;
            opacity: 0;
            visibility: hidden;
            transition: opacity var(--transition-speed), visibility var(--transition-speed);
        }

        .overlay.active {
            opacity: 1;
            visibility: visible;
        }

        .modal {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) scale(0.9);
            background-color: var(--surface);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow-3);
            z-index: 300;
            width: 90%;
            max-width: 500px;
            max-height: 80vh;
            overflow-y: auto;
            opacity: 0;
            visibility: hidden;
            transition: opacity var(--transition-speed), visibility var(--transition-speed), transform var(--transition-speed);
        }

        .modal.active {
            opacity: 1;
            visibility: visible;
            transform: translate(-50%, -50%) scale(1);
        }

        .modal-header {
            padding: 20px;
            border-bottom: 1px solid rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-title {
            font-size: 20px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .modal-close {
            background: none;
            border: none;
            color: var(--text-primary);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 36px;
            height: 36px;
            border-radius: 50%;
        }

        .modal-body {
            padding: 20px;
        }

        .theme-selector {
            display: flex;
            margin-bottom: 20px;
        }

        .theme-option {
            flex: 1;
            padding: 16px;
            border-radius: var(--border-radius);
            cursor: pointer;
            text-align: center;
            transition: all var(--transition-speed);
            border: 2px solid transparent;
        }

        .theme-option.active {
            border-color: var(--primary);
            background-color: var(--primary-light);
        }

        .theme-option .material-icons {
            font-size: 32px;
            margin-bottom: 8px;
            color: var(--primary);
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: var(--text-primary);
        }

        .form-input, .form-textarea {
            width: 100%;
            padding: 12px;
            border: 1px solid rgba(0,0,0,0.2);
            border-radius: 8px;
            background-color: var(--background);
            color: var(--text-primary);
            font-family: 'Inter', sans-serif;
            font-size: 16px;
            outline: none;
            transition: border-color var(--transition-speed);
        }

        .form-input:focus, .form-textarea:focus {
            border-color: var(--primary);
        }

        .form-textarea {
            min-height: 120px;
            resize: vertical;
        }

        .model-option {
            display: flex;
            align-items: center;
            padding: 16px;
            border-radius: var(--border-radius);
            margin-bottom: 12px;
            cursor: pointer;
            transition: all var(--transition-speed);
            border: 2px solid transparent;
        }

        .model-option.active {
            border-color: var(--primary);
            background-color: var(--primary-light);
        }

        .model-info {
            flex-grow: 1;
        }

        .model-name {
            font-weight: 600;
            margin-bottom: 4px;
            color: var(--text-primary);
        }

        .model-description {
            font-size: 14px;
            color: var(--text-secondary);
        }

        .model-check {
            color: var(--primary);
            opacity: 0;
            transition: opacity var(--transition-speed);
        }

        .model-option.active .model-check {
            opacity: 1;
        }

        .chat-history-item {
            padding: 16px;
            border-radius: var(--border-radius);
            margin-bottom: 12px;
            cursor: pointer;
            transition: all var(--transition-speed);
            border: 1px solid rgba(0,0,0,0.1);
        }

        .chat-history-item:hover {
            background-color: var(--primary-light);
            border-color: var(--primary);
        }

        .chat-history-title {
            font-weight: 500;
            margin-bottom: 4px;
            color: var(--text-primary);
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .chat-history-preview {
            font-size: 14px;
            color: var(--text-secondary);
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .chat-history-date {
            font-size: 12px;
            color: var(--text-secondary);
            margin-top: 4px;
        }

        .about-content {
            line-height: 1.6;
            color: var(--text-primary);
        }

        .about-section {
            margin-bottom: 20px;
        }

        .about-title {
            font-weight: 600;
            margin-bottom: 8px;
            color: var(--primary);
        }

        .typing-indicator {
            display: flex;
            margin-bottom: 16px;
            max-width: 80%;
        }

        .typing-bubble {
            background-color: var(--bot-bubble);
            color: var(--text-primary);
            border-radius: var(--message-radius);
            border-bottom-left-radius: 4px;
            padding: 12px 16px;
            box-shadow: var(--shadow-1);
            display: flex;
            align-items: center;
            border: 1px solid rgba(0,0,0,0.1);
        }

        .typing-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background-color: var(--text-secondary);
            margin: 0 2px;
            animation: typing 1.4s infinite;
        }

        .typing-dot:nth-child(2) {
            animation-delay: 0.2s;
        }

        .typing-dot:nth-child(3) {
            animation-delay: 0.4s;
        }

        @keyframes typing {
            0%, 60%, 100% {
                transform: translateY(0);
            }
            30% {
                transform: translateY(-10px);
            }
        }

        .footer {
            text-align: center;
            padding: 16px;
            font-size: 12px;
            color: var(--text-secondary);
            background-color: var(--surface);
            border-top: 1px solid rgba(0,0,0,0.1);
        }

        @media (max-width: 600px) {
            .message {
                max-width: 90%;
            }
            
            .modal {
                width: 95%;
            }
        }
    </style>
</head>
<body>
    <div class="app-header">
        <button class="menu-button" id="menuButton">
            <span class="material-icons">menu</span>
        </button>
        <div class="chat-title" id="chatTitle">New Chat</div>
        <div class="user-profile" id="userProfile">
            <span class="material-icons">person</span>
        </div>
    </div>

    <div class="welcome-container" id="welcomeContainer">
        <div class="welcome-text" id="welcomeText">Welcome! Let's Chat</div>
    </div>

    <div class="chat-container" id="chatContainer">
        <div class="chat-messages" id="chatMessages"></div>
    </div>

    <div class="input-container" id="inputContainer">
        <div class="quick-actions" id="quickActions">
            <div class="quick-action-button" id="imageButton">
                <span class="material-icons">image</span>
            </div>
            <div class="quick-action-button" id="searchButton">
                <span class="material-icons">search</span>
            </div>
            <div class="quick-action-button" id="textButton">
                <span class="material-icons">text_fields</span>
            </div>
        </div>
        <div class="input-pill">
            <input type="text" class="input-field" id="messageInput" placeholder="Type a message...">
            <button class="send-button" id="sendButton">
                <span class="material-icons">send</span>
            </button>
        </div>
        <div class="input-hint" id="inputHint">Chat in English, Sinhala or Tamil</div>
    </div>

    <div class="side-menu" id="sideMenu">
        <div class="menu-header">
            <button class="menu-close" id="menuClose">
                <span class="material-icons">close</span>
            </button>
            <div class="menu-title">Menu</div>
        </div>
        <div class="menu-section">
            <div class="menu-item" id="chatHistoryItem">
                <span class="material-icons">history</span>
                <span>Chat History</span>
            </div>
            <div class="menu-item" id="settingsItem">
                <span class="material-icons">settings</span>
                <span>Settings</span>
            </div>
            <div class="menu-item" id="modelSelectionItem">
                <span class="material-icons">psychology</span>
                <span>Model Selection</span>
            </div>
            <div class="menu-item" id="aboutItem">
                <span class="material-icons">info</span>
                <span>About</span>
            </div>
        </div>
    </div>

    <div class="overlay" id="overlay"></div>

    <div class="modal" id="chatHistoryModal">
        <div class="modal-header">
            <div class="modal-title">Chat History</div>
            <button class="modal-close" data-modal="chatHistoryModal">
                <span class="material-icons">close</span>
            </button>
        </div>
        <div class="modal-body" id="chatHistoryBody">
            <p>No chat history yet.</p>
        </div>
    </div>

    <div class="modal" id="settingsModal">
        <div class="modal-header">
            <div class="modal-title">Settings</div>
            <button class="modal-close" data-modal="settingsModal">
                <span class="material-icons">close</span>
            </button>
        </div>
        <div class="modal-body">
            <div class="theme-selector">
                <div class="theme-option" data-theme="light">
                    <span class="material-icons">light_mode</span>
                    <div>Light</div>
                </div>
                <div class="theme-option" data-theme="dark">
                    <span class="material-icons">dark_mode</span>
                    <div>Dark</div>
                </div>
            </div>
            <div class="form-group">
                <label class="form-label" for="userPreferences">User Preferences</label>
                <textarea class="form-textarea" id="userPreferences" placeholder="Tell us about yourself and how you want AI to respond..."></textarea>
            </div>
            <button class="send-button" id="saveSettings" style="width: 100%; border-radius: 8px;">
                <span class="material-icons">save</span>
            </button>
        </div>
    </div>

    <div class="modal" id="modelSelectionModal">
        <div class="modal-header">
            <div class="modal-title">Model Selection</div>
            <button class="modal-close" data-modal="modelSelectionModal">
                <span class="material-icons">close</span>
            </button>
        </div>
        <div class="modal-body">
            <div class="model-option" data-model="meetare">
                <div class="model-info">
                    <div class="model-name">අමුතු මීටරේ - Amuthu Meetare</div>
                    <div class="model-description">Specialized for mathematical and coding tasks</div>
                </div>
                <span class="material-icons model-check">check_circle</span>
            </div>
            <div class="model-option active" data-model="multi">
                <div class="model-info">
                    <div class="model-name">අමුතු මල්ටි - Amuthu Multi</div>
                    <div class="model-description">Versatile model for everyday tasks and multilingual conversations</div>
                </div>
                <span class="material-icons model-check">check_circle</span>
            </div>
            <div class="model-option" data-model="picasso">
                <div class="model-info">
                    <div class="model-name">අමුතු පිකාසෝ - Amuthu Picasso</div>
                    <div class="model-description">Creative model for songs, poetry and artistic content</div>
                </div>
                <span class="material-icons model-check">check_circle</span>
            </div>
        </div>
    </div>

    <div class="modal" id="aboutModal">
        <div class="modal-header">
            <div class="modal-title">About</div>
            <button class="modal-close" data-modal="aboutModal">
                <span class="material-icons">close</span>
            </button>
        </div>
        <div class="modal-body">
            <div class="about-content">
                <div class="about-section">
                    <div class="about-title">Amuthu AI</div>
                    <p>Amuthu AI is a multilingual conversational AI designed to assist you in English, Sinhala, and Tamil.</p>
                </div>
                <div class="about-section">
                    <div class="about-title">Features</div>
                    <ul>
                        <li>Multilingual support</li>
                        <li>Multiple specialized models</li>
                        <li>Conversation history</li>
                        <li>Customizable user preferences</li>
                    </ul>
                </div>
                <div class="about-section">
                    <div class="about-title">Version</div>
                    <p>1.0.0</p>
                </div>
                <div class="about-section">
                    <div class="about-title">Made by</div>
                    <p>ninsara.dev | Amuthu AI</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const userData = localStorage.getItem('userData');
            if (!userData) {
                window.location.href = 'index.html';
                return;
            }

            const user = JSON.parse(userData);
            const welcomeMessages = [
                `Welcome ${user.fullName}! Let's Chat`,
                `Hello ${user.fullName}! How can I help you today?`,
                `Hi ${user.fullName}! Ready for a conversation?`
            ];
            const randomWelcome = welcomeMessages[Math.floor(Math.random() * welcomeMessages.length)];
            document.getElementById('welcomeText').textContent = randomWelcome;

            if (user.profileImage) {
                document.getElementById('userProfile').innerHTML = `<img src="${user.profileImage}" alt="Profile">`;
            }

            const hasPreid = localStorage.getItem('preid');
            const quickActions = document.getElementById('quickActions');
            
            if (!hasPreid) {
                quickActions.style.display = 'none';
            }

            const theme = localStorage.getItem('theme') || 'light';
            document.documentElement.setAttribute('data-theme', theme);
            document.querySelector(`.theme-option[data-theme="${theme}"]`).classList.add('active');

            const selectedModel = localStorage.getItem('selectedModel') || 'multi';
            
            document.querySelectorAll('.model-option').forEach(opt => {
                opt.classList.remove('active');
                opt.querySelector('.model-check').style.opacity = '0';
            });
            
            document.querySelector(`.model-option[data-model="${selectedModel}"]`).classList.add('active');
            document.querySelector(`.model-option[data-model="${selectedModel}"] .model-check`).style.opacity = '1';

            const userPreferences = localStorage.getItem('userPreferences') || '';
            document.getElementById('userPreferences').value = userPreferences;

            const menuButton = document.getElementById('menuButton');
            const menuClose = document.getElementById('menuClose');
            const sideMenu = document.getElementById('sideMenu');
            const overlay = document.getElementById('overlay');
            const sendButton = document.getElementById('sendButton');
            const messageInput = document.getElementById('messageInput');
            const chatMessages = document.getElementById('chatMessages');
            const chatContainer = document.getElementById('chatContainer');
            const welcomeContainer = document.getElementById('welcomeContainer');
            const chatTitle = document.getElementById('chatTitle');
            const inputHint = document.getElementById('inputHint');
            const userProfile = document.getElementById('userProfile');
            const imageButton = document.getElementById('imageButton');
            const searchButton = document.getElementById('searchButton');
            const textButton = document.getElementById('textButton');

            let currentChat = [];
            let chatHistory = JSON.parse(localStorage.getItem('chatHistory')) || [];
            let isLoading = false;
            
            // Encrypted API key
            const G83H82R3 = [115,107,45,111,114,45,118,49,45,100,51,101,49,50,99,50,101,50,52,100,56,48,102,48,49,99,49,51,102,102,98,100,54,50,56,102,53,49,56,55,51,56,49,56,54,97,100,54,51,57,49,48,57,102,56,50,100,97,56,48,98,102,100,48,50,101,51,50,56,100,52,56,55];
            
            function decodeSecret(encoded) {
                return encoded.map(code => String.fromCharCode(code)).join('');
            }
            
            const apiKey = decodeSecret(G83H82R3);

            menuButton.addEventListener('click', function() {
                sideMenu.classList.add('open');
                overlay.classList.add('active');
            });

            menuClose.addEventListener('click', function() {
                sideMenu.classList.remove('open');
                overlay.classList.remove('active');
            });

            overlay.addEventListener('click', function() {
                sideMenu.classList.remove('open');
                overlay.classList.remove('active');
                document.querySelectorAll('.modal').forEach(modal => {
                    modal.classList.remove('active');
                });
            });

            document.querySelectorAll('.modal-close').forEach(button => {
                button.addEventListener('click', function() {
                    const modalId = this.getAttribute('data-modal');
                    document.getElementById(modalId).classList.remove('active');
                    overlay.classList.remove('active');
                });
            });

            document.getElementById('chatHistoryItem').addEventListener('click', function() {
                loadChatHistory();
                document.getElementById('chatHistoryModal').classList.add('active');
                overlay.classList.add('active');
            });

            document.getElementById('settingsItem').addEventListener('click', function() {
                document.getElementById('settingsModal').classList.add('active');
                overlay.classList.add('active');
            });

            document.getElementById('modelSelectionItem').addEventListener('click', function() {
                document.getElementById('modelSelectionModal').classList.add('active');
                overlay.classList.add('active');
            });

            document.getElementById('aboutItem').addEventListener('click', function() {
                document.getElementById('aboutModal').classList.add('active');
                overlay.classList.add('active');
            });

            document.querySelectorAll('.theme-option').forEach(option => {
                option.addEventListener('click', function() {
                    const theme = this.getAttribute('data-theme');
                    document.documentElement.setAttribute('data-theme', theme);
                    localStorage.setItem('theme', theme);
                    
                    document.querySelectorAll('.theme-option').forEach(opt => {
                        opt.classList.remove('active');
                    });
                    this.classList.add('active');
                });
            });

            document.querySelectorAll('.model-option').forEach(option => {
                option.addEventListener('click', function() {
                    const model = this.getAttribute('data-model');
                    localStorage.setItem('selectedModel', model);
                    
                    document.querySelectorAll('.model-option').forEach(opt => {
                        opt.classList.remove('active');
                        opt.querySelector('.model-check').style.opacity = '0';
                    });
                    this.classList.add('active');
                    this.querySelector('.model-check').style.opacity = '1';
                });
            });

            document.getElementById('saveSettings').addEventListener('click', function() {
                const preferences = document.getElementById('userPreferences').value;
                localStorage.setItem('userPreferences', preferences);
                
                document.getElementById('settingsModal').classList.remove('active');
                overlay.classList.remove('active');
                
                showNotification('Settings saved successfully!');
            });

            userProfile.addEventListener('click', function() {
                window.location.href = 'user.html';
            });

            imageButton.addEventListener('click', function() {
                window.location.href = 'image.html';
            });

            searchButton.addEventListener('click', function() {
                window.location.href = 'find.html';
            });

            textButton.addEventListener('click', function() {
                window.location.href = 'text.html';
            });

            messageInput.addEventListener('focus', function() {
                inputHint.classList.add('visible');
            });

            messageInput.addEventListener('blur', function() {
                inputHint.classList.remove('visible');
            });

            messageInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendMessage();
                }
            });

            sendButton.addEventListener('click', sendMessage);

            function sendMessage() {
                const message = messageInput.value.trim();
                if (!message || isLoading) return;

                if (currentChat.length === 0) {
                    quickActions.style.display = 'none';
                    welcomeContainer.style.display = 'none';
                    chatContainer.style.display = 'flex';
                    chatTitle.textContent = message.length > 30 ? message.substring(0, 30) + '...' : message;
                }

                addMessage(message, 'user');
                messageInput.value = '';
                
                showTypingIndicator();
                isLoading = true;
                
                setTimeout(() => {
                    getBotResponse(message);
                }, 1000);
            }

            function addMessage(text, sender) {
                const messageDiv = document.createElement('div');
                messageDiv.className = `message ${sender}`;
                
                const now = new Date();
                const timeString = now.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                
                if (sender === 'user') {
                    const userAvatar = user.profileImage ? 
                        `<img src="${user.profileImage}" alt="Profile">` : 
                        `<span class="material-icons">person</span>`;
                        
                    messageDiv.innerHTML = `
                        <div class="message-avatar">${userAvatar}</div>
                        <div>
                            <div class="message-bubble">${escapeHtml(text)}</div>
                            <div class="message-time">${timeString}</div>
                        </div>
                    `;
                } else {
                    messageDiv.innerHTML = `
                        <div class="message-avatar">
                            <span class="material-icons">smart_toy</span>
                        </div>
                        <div>
                            <div class="message-bubble">${text}</div>
                            <div class="message-time">${timeString}</div>
                        </div>
                    `;
                }
                
                chatMessages.appendChild(messageDiv);
                chatMessages.scrollTop = chatMessages.scrollHeight;
                
                currentChat.push({
                    text: text,
                    sender: sender,
                    time: now.toISOString()
                });
            }

            function showTypingIndicator() {
                const typingDiv = document.createElement('div');
                typingDiv.className = 'typing-indicator';
                typingDiv.id = 'typingIndicator';
                typingDiv.innerHTML = `
                    <div class="message-avatar">
                        <span class="material-icons">smart_toy</span>
                    </div>
                    <div class="typing-bubble">
                        <div class="typing-dot"></div>
                        <div class="typing-dot"></div>
                        <div class="typing-dot"></div>
                    </div>
                `;
                
                chatMessages.appendChild(typingDiv);
                chatMessages.scrollTop = chatMessages.scrollHeight;
            }

            function hideTypingIndicator() {
                const typingIndicator = document.getElementById('typingIndicator');
                if (typingIndicator) {
                    typingIndicator.remove();
                }
            }

            async function getBotResponse(userMessage) {
                try {
                    const selectedModel = localStorage.getItem('selectedModel') || 'multi';
                    const userPreferences = localStorage.getItem('userPreferences') || '';
                    
                    let systemPrompt = '';
                    switch (selectedModel) {
                        case 'meetare':
                            systemPrompt = `You are Amuthu Meetare, a specialized AI assistant for mathematical and coding tasks. Provide accurate, detailed answers to math problems and coding questions. You can communicate in English, Sinhala, and Tamil. Use simple, everyday language that is easy to understand.`;
                            break;
                        case 'multi':
                            systemPrompt = `You are Amuthu Multi, a versatile AI assistant for everyday tasks. You can communicate fluently in English, Sinhala, and Tamil using simple, everyday language. Be helpful, friendly, and conversational.`;
                            break;
                        case 'picasso':
                            systemPrompt = `You are Amuthu Picasso, a creative AI assistant specialized in songs, poetry, and artistic content. You can communicate in English, Sinhala, and Tamil using simple, everyday language. Be creative, expressive, and inspiring.`;
                            break;
                        default:
                            systemPrompt = `You are Amuthu AI, a helpful assistant. You can communicate in English, Sinhala, and Tamil using simple, everyday language.`;
                    }
                    
                    if (user.fullName) {
                        systemPrompt += ` The user's name is ${user.fullName}. Please address them by this name in your responses.`;
                    }
                    
                    if (userPreferences) {
                        systemPrompt += ` User preferences: ${userPreferences}`;
                    }
                    
                    // Initialize conversation history with system message
                    let conversationHistory = [{
                        role: "system",
                        content: systemPrompt
                    }];
                    
                    // Add previous messages from current chat
                    currentChat.forEach(msg => {
                        conversationHistory.push({
                            role: msg.sender === 'user' ? 'user' : 'assistant',
                            content: msg.text
                        });
                    });
                    
                    const response = await fetch("https://openrouter.ai/api/v1/chat/completions", {
                        method: "POST",
                        headers: {
                            "Content-Type": "application/json",
                            "Authorization": `Bearer ${apiKey}`,
                            "HTTP-Referer": window.location.href,
                            "X-Title": "Amuthu AI"
                        },
                        body: JSON.stringify({
                            model: "meta-llama/llama-3-70b-instruct",
                            messages: conversationHistory,
                            temperature: 0.7,
                            max_tokens: 1000
                        })
                    });
                    
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    
                    const data = await response.json();
                    if (!data.choices || !data.choices[0] || !data.choices[0].message) {
                        throw new Error('Invalid response format');
                    }
                    
                    const botMessage = data.choices[0].message.content;
                    
                    hideTypingIndicator();
                    addMessage(botMessage, 'bot');
                    isLoading = false;
                } catch (error) {
                    console.error('Error getting bot response:', error);
                    hideTypingIndicator();
                    addMessage('Sorry, I encountered an error while processing your request. Please try again.', 'bot');
                    isLoading = false;
                }
            }

            function saveCurrentChat() {
                if (currentChat.length === 0) return;
                
                const chatTitle = currentChat[0].sender === 'user' ? 
                    (currentChat[0].text.length > 30 ? currentChat[0].text.substring(0, 30) + '...' : currentChat[0].text) : 
                    'New Chat';
                
                const chatData = {
                    id: Date.now(),
                    title: chatTitle,
                    messages: currentChat,
                    createdAt: new Date().toISOString()
                };
                
                chatHistory.unshift(chatData);
                if (chatHistory.length > 10) {
                    chatHistory = chatHistory.slice(0, 10);
                }
                
                localStorage.setItem('chatHistory', JSON.stringify(chatHistory));
            }

            function loadChatHistory() {
                const chatHistoryBody = document.getElementById('chatHistoryBody');
                
                if (chatHistory.length === 0) {
                    chatHistoryBody.innerHTML = '<p>No chat history yet.</p>';
                    return;
                }
                
                chatHistoryBody.innerHTML = '';
                
                chatHistory.forEach(chat => {
                    const chatItem = document.createElement('div');
                    chatItem.className = 'chat-history-item';
                    
                    const date = new Date(chat.createdAt);
                    const dateString = date.toLocaleDateString();
                    
                    const firstUserMessage = chat.messages.find(msg => msg.sender === 'user');
                    const preview = firstUserMessage ? 
                        (firstUserMessage.text.length > 50 ? firstUserMessage.text.substring(0, 50) + '...' : firstUserMessage.text) : 
                        'No messages';
                    
                    chatItem.innerHTML = `
                        <div class="chat-history-title">${escapeHtml(chat.title)}</div>
                        <div class="chat-history-preview">${escapeHtml(preview)}</div>
                        <div class="chat-history-date">${dateString}</div>
                    `;
                    
                    chatItem.addEventListener('click', function() {
                        loadChat(chat.id);
                        document.getElementById('chatHistoryModal').classList.remove('active');
                        overlay.classList.remove('active');
                    });
                    
                    chatHistoryBody.appendChild(chatItem);
                });
            }

            function loadChat(chatId) {
                const chat = chatHistory.find(c => c.id === chatId);
                if (!chat) return;
                
                currentChat = chat.messages;
                chatTitle.textContent = chat.title;
                
                welcomeContainer.style.display = 'none';
                chatContainer.style.display = 'flex';
                quickActions.style.display = 'none';
                
                chatMessages.innerHTML = '';
                
                currentChat.forEach(msg => {
                    const messageDiv = document.createElement('div');
                    messageDiv.className = `message ${msg.sender}`;
                    
                    const time = new Date(msg.time);
                    const timeString = time.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                    
                    if (msg.sender === 'user') {
                        const userAvatar = user.profileImage ? 
                            `<img src="${user.profileImage}" alt="Profile">` : 
                            `<span class="material-icons">person</span>`;
                            
                        messageDiv.innerHTML = `
                            <div class="message-avatar">${userAvatar}</div>
                            <div>
                                <div class="message-bubble">${escapeHtml(msg.text)}</div>
                                <div class="message-time">${timeString}</div>
                            </div>
                        `;
                    } else {
                        messageDiv.innerHTML = `
                            <div class="message-avatar">
                                <span class="material-icons">smart_toy</span>
                            </div>
                            <div>
                                <div class="message-bubble">${msg.text}</div>
                                <div class="message-time">${timeString}</div>
                            </div>
                        `;
                    }
                    
                    chatMessages.appendChild(messageDiv);
                });
                
                chatMessages.scrollTop = chatMessages.scrollHeight;
            }

            function escapeHtml(text) {
                const map = {
                    '&': '&amp;',
                    '<': '&lt;',
                    '>': '&gt;',
                    '"': '&quot;',
                    "'": '&#039;'
                };
                
                return text.replace(/[&<>"']/g, m => map[m]);
            }

            function showNotification(message) {
                const notification = document.createElement('div');
                notification.style.position = 'fixed';
                notification.style.bottom = '20px';
                notification.style.left = '50%';
                notification.style.transform = 'translateX(-50%)';
                notification.style.backgroundColor = 'var(--primary)';
                notification.style.color = 'white';
                notification.style.padding = '12px 24px';
                notification.style.borderRadius = '24px';
                notification.style.boxShadow = 'var(--shadow-2)';
                notification.style.zIndex = '1000';
                notification.style.opacity = '0';
                notification.style.transition = 'opacity 0.3s';
                notification.textContent = message;
                
                document.body.appendChild(notification);
                
                setTimeout(() => {
                    notification.style.opacity = '1';
                }, 10);
                
                setTimeout(() => {
                    notification.style.opacity = '0';
                    setTimeout(() => {
                        document.body.removeChild(notification);
                    }, 300);
                }, 3000);
            }

            window.addEventListener('beforeunload', function() {
                saveCurrentChat();
            });
        });
    </script>
</body>
</html>
